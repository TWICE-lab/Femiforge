<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Details | FemiForge Student Portal</title>
    <style>
        /* Reuse base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-decoration: none;
            color: #8a2be2;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .logo span {
            color: #ff69b4;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #8a2be2, #ff69b4);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        /* Main Layout */
        .dashboard {
            display: flex;
            min-height: 100vh;
            padding-top: 70px;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: white;
            border-right: 1px solid #e1e5eb;
            padding: 2rem 0;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 2rem;
            color: #555;
            text-decoration: none;
            border-left: 3px solid transparent;
        }

        .nav-item:hover,
        .nav-item.active {
            background: #f0f2ff;
            color: #8a2be2;
            border-left-color: #8a2be2;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 2rem;
        }

        /* Back Button */
        .back-button {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: #8a2be2;
            text-decoration: none;
            margin-bottom: 2rem;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            transition: background 0.3s ease;
        }

        .back-button:hover {
            background: #f0f2ff;
        }

        /* Course Header */
        .course-header {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .course-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .course-category {
            background: #8a2be2;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .course-level {
            background: #f0f2ff;
            color: #8a2be2;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .course-rating {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            color: #ffc107;
        }

        .course-title {
            font-size: 2rem;
            color: #333;
            margin-bottom: 1rem;
        }

        .course-instructor {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .instructor-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #f0f2ff;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
        }

        .instructor-info h3 {
            color: #333;
            margin-bottom: 0.25rem;
        }

        .instructor-info p {
            color: #666;
            font-size: 0.9rem;
        }

        /* Course Stats */
        .course-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: #f8f9ff;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #8a2be2;
            margin-bottom: 0.25rem;
        }

        .stat-label {
            color: #666;
            font-size: 0.85rem;
        }

        /* Progress Section */
        .progress-section {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .progress-bar {
            height: 10px;
            background: #e1e5eb;
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .progress-fill {
            height: 100%;
            background: #8a2be2;
            border-radius: 5px;
            transition: width 0.3s ease;
        }

        .progress-text {
            display: flex;
            justify-content: space-between;
            color: #666;
            font-size: 0.9rem;
        }

        /* Course Content */
        .course-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .content-section {
            margin-bottom: 2rem;
        }

        .content-section:last-child {
            margin-bottom: 0;
        }

        .section-title {
            color: #333;
            font-size: 1.25rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #f0f2ff;
        }

        .module-list {
            list-style: none;
        }

        .module-item {
            display: flex;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #e1e5eb;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .module-item:last-child {
            border-bottom: none;
        }

        .module-item:hover {
            background: #f8f9ff;
        }

        .module-item.completed .module-title {
            text-decoration: line-through;
            color: #666;
        }

        .module-status {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #ddd;
            margin-right: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .module-item.completed .module-status {
            background: #8a2be2;
            border-color: #8a2be2;
            color: white;
        }

        .module-info {
            flex: 1;
        }

        .module-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .module-duration {
            color: #666;
            font-size: 0.85rem;
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            background: #8a2be2;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: background 0.3s ease;
        }

        .btn:hover {
            background: #6a1cb0;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #8a2be2;
            color: #8a2be2;
        }

        .btn-outline:hover {
            background: #8a2be2;
            color: white;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        /* Resources */
        .resources-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .resource-card {
            background: #f8f9ff;
            padding: 1rem;
            border-radius: 8px;
            text-decoration: none;
            color: #333;
            transition: transform 0.3s ease;
        }

        .resource-card:hover {
            transform: translateY(-2px);
        }

        .resource-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .resource-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .resource-type {
            color: #666;
            font-size: 0.85rem;
        }

        /* Completion Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            max-width: 400px;
            width: 100%;
            text-align: center;
        }

        .modal-icon {
            font-size: 4rem;
            color: #8a2be2;
            margin-bottom: 1rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                width: 70px;
            }

            .nav-item span {
                display: none;
            }

            .nav-item {
                justify-content: center;
                padding: 0.75rem;
            }

            .course-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .action-buttons {
                flex-direction: column;
            }

            .resources-list {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .course-stats {
                grid-template-columns: 1fr;
            }

            .course-meta {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <a href="dashboard.html" class="logo">
                <div class="logo-icon">FF</div>
                <div>Femi<span>Forge</span></div>
            </a>
            
            <div class="user-menu">
                <div class="user-avatar" id="headerAvatar">
            <!-- This will be updated with image or initial -->
        </div>
            </div>
        </div>
    </header>

    <!-- Dashboard -->
    <div class="dashboard">
        <!-- Sidebar -->
        <nav class="sidebar">
            <a href="dashboard.html" class="nav-item">
                <span>üìä</span>
                <span>Dashboard</span>
            </a>
            <a href="courses.html" class="nav-item">
                <span>üìö</span>
                <span>My Courses</span>
            </a>
            <a href="progress.html" class="nav-item">
                <span>üìà</span>
                <span>Progress</span>
            </a>
            <a href="profile.html" class="nav-item">
                <span>üë§</span>
                <span>Profile</span>
            </a>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Back Button -->
            <a href="courses.html" class="back-button">
                <span>‚Üê</span> Back to Courses
            </a>

            <!-- Course Header -->
            <div class="course-header">
                <div class="course-meta">
                    <span class="course-category" id="courseCategory">Business</span>
                    <span class="course-level" id="courseLevel">Beginner</span>
                    <span class="course-rating">
                        <span>‚òÖ</span>
                        <span>‚òÖ</span>
                        <span>‚òÖ</span>
                        <span>‚òÖ</span>
                        <span>‚òÜ</span>
                        <span style="color: #666; margin-left: 0.5rem;">4.5</span>
                    </span>
                </div>
                
                <h1 class="course-title" id="courseTitle">Course Title</h1>
                
                <div class="course-instructor">
                    <div class="instructor-avatar" id="instructorAvatar">J</div>
                    <div class="instructor-info">
                        <h3 id="instructorName">Instructor Name</h3>
                        <p id="instructorBio">Expert in the field with 10+ years of experience</p>
                    </div>
                </div>

                <div class="course-stats">
                    <div class="stat-card">
                        <div class="stat-value" id="statDuration">8 weeks</div>
                        <div class="stat-label">Duration</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statModules">12</div>
                        <div class="stat-label">Modules</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statStudents">120</div>
                        <div class="stat-label">Students</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="statAssignments">5</div>
                        <div class="stat-label">Assignments</div>
                    </div>
                </div>
            </div>

            <!-- Progress Section -->
            <div class="progress-section">
                <div class="progress-header">
                    <h2>Your Progress</h2>
                    <span id="progressPercentage">0%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text">
                    <span>Started: <span id="startDate">-</span></span>
                    <span>Estimated completion: <span id="completionDate">-</span></span>
                </div>
            </div>

            <!-- Course Content -->
            <div class="course-content">
                <div class="content-section">
                    <h2 class="section-title">Course Description</h2>
                    <p id="courseDescription">Loading course description...</p>
                </div>

                <div class="content-section">
                    <h2 class="section-title">Course Modules</h2>
                    <ul class="module-list" id="moduleList">
                        <!-- Modules will be loaded here -->
                    </ul>
                </div>

                <div class="content-section">
                    <h2 class="section-title">Learning Resources</h2>
                    <div class="resources-list" id="resourcesList">
                        <!-- Resources will be loaded here -->
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="btn" id="continueBtn">
                        <span>‚ñ∂</span> Continue Learning
                    </button>
                    <button class="btn btn-outline" id="markCompleteBtn">
                        <span>‚úì</span> Mark as Complete
                    </button>
                    <a href="#" class="btn btn-outline" id="discussionBtn">
                        <span>üí¨</span> Discussion Forum
                    </a>
                </div>
            </div>
        </main>
    </div>

    <!-- Completion Modal -->
    <div class="modal" id="completionModal">
        <div class="modal-content">
            <div class="modal-icon">üéâ</div>
            <h2>Course Completed!</h2>
            <p>Congratulations on completing this course!</p>
            <p>You can now download your certificate.</p>
            <div style="margin-top: 2rem; display: flex; gap: 1rem; justify-content: center;">
                <button class="btn" id="downloadCertificate">
                    <span>üìÑ</span> Download Certificate
                </button>
                <button class="btn btn-outline" id="closeModal">
                    <span>‚úï</span> Close
                </button>
            </div>
        </div>
    </div>

    <script src="js/auth-check.js"></script>
    <script>
       const API_BASE = 'http://localhost:5000/api';

class CourseDetailsPage {
    constructor() {
        this.courseId = null;
        this.course = null;
        this.enrollment = null;
        this.isPreview = false;
    }
    
    async init() {
        // Get course ID from URL
        this.getCourseId();
        
        // Check authentication (except for preview)
        const urlParams = new URLSearchParams(window.location.search);
        this.isPreview = urlParams.get('preview') === 'true';
        
        if (!this.isPreview && !await this.checkAuth()) {
            return;
        }
        
        // Load course data
        await this.loadCourseData();
        
        // Load user data if authenticated
        if (!this.isPreview) {
            await this.loadUserData();
            await this.loadEnrollment();
        }
        
        // Setup event listeners
        this.setupEventListeners();
    }
    
    getCourseId() {
        const urlParams = new URLSearchParams(window.location.search);
        this.courseId = urlParams.get('id');
        
        if (!this.courseId) {
            window.location.href = 'courses.html';
        }
    }
    
    async checkAuth() {
        const token = localStorage.getItem('token');
        
        if (!token) {
            window.location.href = 'login.html';
            return false;
        }
        
        return true;
    }
    
    async loadUserData() {
        try {
            const token = localStorage.getItem('token');
            const userStr = localStorage.getItem('user');
            
            if (userStr) {
                const user = JSON.parse(userStr);
                const avatar = document.getElementById('userAvatar');
                if (avatar) avatar.textContent = user.name.charAt(0).toUpperCase();
            }
        } catch (error) {
            console.error('Error loading user data:', error);
        }
    }
    
    async loadCourseData() {
        try {
            const token = localStorage.getItem('token');
            
            // For preview mode, fetch without auth header
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (!this.isPreview && token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            const response = await fetch(`${API_BASE}/courses/${this.courseId}`, {
                headers
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.course = data.data;
                this.populateCourseData();
                this.generateModules();
                this.generateResources();
            } else {
                throw new Error(data.error || 'Course not found');
            }
            
        } catch (error) {
            console.error('Error loading course:', error);
            this.showNotification('Failed to load course', 'error');
            setTimeout(() => {
                window.location.href = 'courses.html';
            }, 2000);
        }
    }
    
    async loadEnrollment() {
        try {
            const token = localStorage.getItem('token');
            const response = await fetch(`${API_BASE}/enrollments/course/${this.courseId}`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.enrollment = data.data.enrollment;
                this.updateProgress(data.data.progress);
            }
            
        } catch (error) {
            console.error('Error loading enrollment:', error);
            // If not enrolled, hide some features
            this.handleNotEnrolled();
        }
    }
    
    populateCourseData() {
        if (!this.course) return;
        
        // Populate course information
        document.getElementById('courseTitle').textContent = this.course.title;
        document.getElementById('courseCategory').textContent = this.course.category;
        document.getElementById('courseLevel').textContent = this.course.level;
        document.getElementById('courseDescription').textContent = this.course.description;
        
        // Instructor info
        if (this.course.instructor) {
            document.getElementById('instructorName').textContent = this.course.instructor.name;
            document.getElementById('instructorAvatar').textContent = this.course.instructor.name.charAt(0).toUpperCase();
            document.getElementById('instructorBio').textContent = this.course.instructor.bio || 'Expert instructor';
        }
        
        // Stats
        document.getElementById('statDuration').textContent = this.course.duration;
        document.getElementById('statStudents').textContent = this.course.enrolledCount || 0;
        document.getElementById('statModules').textContent = this.course.modules?.length || 0;
        document.getElementById('statAssignments').textContent = this.course.modules?.reduce((total, module) => 
            total + (module.lessons?.length || 0), 0) || 0;
        
        // Update continue button text for preview mode
        if (this.isPreview) {
            const continueBtn = document.getElementById('continueBtn');
            if (continueBtn) {
                continueBtn.textContent = 'Enroll to Continue';
                continueBtn.onclick = () => this.enrollInCourse();
            }
            
            const markCompleteBtn = document.getElementById('markCompleteBtn');
            if (markCompleteBtn) markCompleteBtn.style.display = 'none';
        }
    }
    
    updateProgress(progress) {
        if (!progress) return;
        
        const progressPercentage = progress.progressPercentage || 0;
        const progressFill = document.getElementById('progressFill');
        const progressText = document.getElementById('progressPercentage');
        
        if (progressFill) {
            progressFill.style.width = progressPercentage + '%';
        }
        
        if (progressText) {
            progressText.textContent = progressPercentage + '%';
        }
        
        // Update dates
        if (progress.lastAccessed) {
            document.getElementById('startDate').textContent = 
                new Date(progress.lastAccessed).toLocaleDateString();
        }
        
        // Calculate estimated completion
        if (progressPercentage < 100) {
            const remaining = 100 - progressPercentage;
            const estimatedDays = Math.ceil(remaining / 10); // Simple estimation
            const completionDate = new Date();
            completionDate.setDate(completionDate.getDate() + estimatedDays);
            document.getElementById('completionDate').textContent = completionDate.toLocaleDateString();
        } else {
            document.getElementById('completionDate').textContent = 'Completed!';
            
            // Update button text
            const continueBtn = document.getElementById('continueBtn');
            if (continueBtn) continueBtn.textContent = 'Review Course';
            
            // Hide mark complete button
            const markCompleteBtn = document.getElementById('markCompleteBtn');
            if (markCompleteBtn) markCompleteBtn.style.display = 'none';
        }
    }
    
    handleNotEnrolled() {
        // Hide progress section
        const progressSection = document.querySelector('.progress-section');
        if (progressSection) progressSection.style.display = 'none';
        
        // Update button text
        const continueBtn = document.getElementById('continueBtn');
        if (continueBtn) {
            continueBtn.textContent = 'Enroll Now';
            continueBtn.onclick = () => this.enrollInCourse();
        }
        
        // Hide mark complete button
        const markCompleteBtn = document.getElementById('markCompleteBtn');
        if (markCompleteBtn) markCompleteBtn.style.display = 'none';
        
        // Show preview notice
        this.showNotification('Preview mode. Enroll to access full content.', 'info');
    }
    
    generateModules() {
        const modules = this.course.modules || [];
        const moduleList = document.getElementById('moduleList');
        
        if (!moduleList) return;
        
        if (!modules || modules.length === 0) {
            moduleList.innerHTML = '<li class="module-item"><div class="module-info">No modules available yet</div></li>';
            return;
        }
        
        // For preview mode, only show first module
        const displayModules = this.isPreview ? modules.slice(0, 1) : modules;
        
        moduleList.innerHTML = displayModules.map((module, index) => {
            const isCompleted = false; // You would check against enrollment progress
            
            return `
                <li class="module-item ${isCompleted ? 'completed' : ''}" data-module-id="${module._id || index}">
                    <div class="module-status">
                        ${isCompleted ? '‚úì' : index + 1}
                    </div>
                    <div class="module-info">
                        <div class="module-title">${module.title}</div>
                        <div class="module-duration">${module.duration || 'Duration not specified'}</div>
                    </div>
                </li>
            `;
        }).join('');
        
        // Add click events
        document.querySelectorAll('.module-item').forEach(item => {
            item.addEventListener('click', (e) => {
                const moduleId = e.currentTarget.dataset.moduleId;
                this.openModule(moduleId);
            });
        });
    }
    
    generateResources() {
        const resources = this.course.resources || [
            { title: 'Course Materials', type: 'pdf', icon: 'üìÑ' },
            { title: 'Video Lectures', type: 'video', icon: 'üé¨' },
            { title: 'Practice Quizzes', type: 'quiz', icon: '‚ùì' },
            { title: 'Additional Reading', type: 'link', icon: 'üìñ' }
        ];
        
        const resourcesList = document.getElementById('resourcesList');
        if (!resourcesList) return;
        
        resourcesList.innerHTML = resources.map(resource => `
            <a href="#" class="resource-card" data-resource-id="${resource._id || resource.title}">
                <div class="resource-icon">${resource.icon || 'üìÅ'}</div>
                <div class="resource-name">${resource.title}</div>
                <div class="resource-type">${resource.type || 'Resource'}</div>
            </a>
        `).join('');
    }
    
    async enrollInCourse() {
        if (this.isPreview) {
            // Redirect to login if not authenticated
            if (!localStorage.getItem('token')) {
                window.location.href = `login.html?redirect=course-details.html?id=${this.courseId}`;
                return;
            }
        }
        
        try {
            const token = localStorage.getItem('token');
            const response = await fetch(`${API_BASE}/enrollments`, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ courseId: this.courseId })
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.showNotification('Successfully enrolled in the course!', 'success');
                
                // Reload page in full access mode
                setTimeout(() => {
                    window.location.href = `course-details.html?id=${this.courseId}`;
                }, 1500);
            } else {
                this.showNotification(data.error || 'Enrollment failed', 'error');
            }
            
        } catch (error) {
            console.error('Error enrolling:', error);
            this.showNotification('Network error. Please try again.', 'error');
        }
    }
    
    openModule(moduleId) {
        if (this.isPreview) {
            this.showNotification('Enroll in the course to access modules', 'info');
            return;
        }
        
        // In a real app, this would open the module player
        this.showNotification(`Opening module ${moduleId}...`, 'info');
        
        // Update progress
        this.updateModuleProgress(moduleId);
    }
    
    async updateModuleProgress(moduleId) {
        try {
            if (!this.enrollment) return;
            
            const token = localStorage.getItem('token');
            const response = await fetch(`${API_BASE}/enrollments/${this.enrollment._id}/progress`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    moduleId,
                    timeSpent: 5, // minutes
                    completed: true
                })
            });
            
            const data = await response.json();
            
            if (data.success) {
                // Update progress display
                this.updateProgress(data.data);
            }
            
        } catch (error) {
            console.error('Error updating progress:', error);
        }
    }
    
    async markAsComplete() {
        if (!this.enrollment) {
            this.showNotification('You are not enrolled in this course', 'error');
            return;
        }
        
        if (!confirm('Mark this course as complete?')) {
            return;
        }
        
        try {
            const token = localStorage.getItem('token');
            const response = await fetch(`${API_BASE}/enrollments/${this.enrollment._id}/complete`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                this.showNotification('Course marked as complete!', 'success');
                
                // Show certificate modal
                this.showCompletionModal();
                
                // Update UI
                this.updateProgress({ progressPercentage: 100 });
                
            } else {
                this.showNotification(data.error || 'Failed to mark as complete', 'error');
            }
            
        } catch (error) {
            console.error('Error marking as complete:', error);
            this.showNotification('Network error. Please try again.', 'error');
        }
    }
    
    showCompletionModal() {
        document.getElementById('completionModal').classList.add('active');
    }
    
    hideCompletionModal() {
        document.getElementById('completionModal').classList.remove('active');
    }
    
    async downloadCertificate() {
        if (!this.enrollment) {
            this.showNotification('No enrollment found', 'error');
            return;
        }
        
        try {
            const token = localStorage.getItem('token');
            const response = await fetch(`${API_BASE}/enrollments/${this.enrollment._id}/certificate`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                // In a real app, this would download a PDF
                this.showNotification('Certificate download started!', 'success');
                this.hideCompletionModal();
            } else {
                throw new Error(data.error || 'Failed to download certificate');
            }
            
        } catch (error) {
            console.error('Error downloading certificate:', error);
            this.showNotification('Failed to download certificate', 'error');
        }
    }
    
    showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.innerHTML = `
            <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
            <span>${message}</span>
        `;
        
        notification.style.cssText = `
            position: fixed;
            top: 100px;
            right: 20px;
            background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 9999;
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        `;
        
        document.body.appendChild(notification);
        
        setTimeout(() => {
            notification.style.animation = 'slideOut 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }
    
    setupEventListeners() {
        // Continue button
        const continueBtn = document.getElementById('continueBtn');
        if (continueBtn && !this.isPreview) {
            continueBtn.addEventListener('click', () => {
                if (this.enrollment && this.course.modules && this.course.modules.length > 0) {
                    const firstModule = this.course.modules[0];
                    this.openModule(firstModule._id || 0);
                } else {
                    this.showNotification('No modules available', 'info');
                }
            });
        }
        
        // Mark as complete button
        const markCompleteBtn = document.getElementById('markCompleteBtn');
        if (markCompleteBtn) {
            markCompleteBtn.addEventListener('click', () => {
                this.markAsComplete();
            });
        }
        
        // Discussion forum button
        const discussionBtn = document.getElementById('discussionBtn');
        if (discussionBtn) {
            discussionBtn.addEventListener('click', (e) => {
                e.preventDefault();
                this.showNotification('Discussion forum would open here', 'info');
            });
        }
        
        // Resource cards
        document.querySelectorAll('.resource-card').forEach(card => {
            card.addEventListener('click', (e) => {
                e.preventDefault();
                
                if (this.isPreview) {
                    this.showNotification('Enroll to access resources', 'info');
                    return;
                }
                
                const resourceId = e.currentTarget.dataset.resourceId;
                this.showNotification(`Downloading resource: ${resourceId}`, 'info');
            });
        });
        
        // Completion modal buttons
        const downloadCertBtn = document.getElementById('downloadCertificate');
        const closeModalBtn = document.getElementById('closeModal');
        const completionModal = document.getElementById('completionModal');
        
        if (downloadCertBtn) {
            downloadCertBtn.addEventListener('click', () => {
                this.downloadCertificate();
            });
        }
        
        if (closeModalBtn) {
            closeModalBtn.addEventListener('click', () => {
                this.hideCompletionModal();
            });
        }
        
        if (completionModal) {
            completionModal.addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    this.hideCompletionModal();
                }
            });
        }
        
        // Logout
        const logoutLinks = document.querySelectorAll('a[href="#logout"]');
        logoutLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                if (confirm('Are you sure you want to logout?')) {
                    localStorage.removeItem('token');
                    localStorage.removeItem('user');
                    window.location.href = 'login.html';
                }
            });
        });
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', () => {
    const courseDetailsPage = new CourseDetailsPage();
    courseDetailsPage.init();
});

// Function to update header avatar
async function updateHeaderAvatar() {
    const token = localStorage.getItem('token');
    const userStr = localStorage.getItem('user');
    const headerAvatar = document.getElementById('headerAvatar');
    
    if (!headerAvatar) return;
    
    if (userStr) {
        const user = JSON.parse(userStr);
        
        // Check if user has avatar
        if (user.avatar) {
            headerAvatar.innerHTML = `
                <img src="${user.avatar}" alt="Profile" 
                     style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;">
            `;
        } else {
            // Show initial
            headerAvatar.textContent = user.name.charAt(0).toUpperCase();
        }
    }
}

// Call this function when page loads
updateHeaderAvatar();
    </script>

</body>
</html>
